name: Build Kivy APK

on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip build-essential git zip unzip openjdk-17-jdk \
          libncurses6 libffi-dev libssl-dev libsqlite3-dev libjpeg-dev libfreetype6-dev \
          libsdl2-dev libgles2-mesa-dev libgstreamer1.0-dev libmtdev-dev libgl1-mesa-dev \
          libavcodec-dev libavformat-dev libswscale-dev libbz2-dev liblzma-dev zlib1g-dev \
          libtiff-dev libx11-dev libpng-dev libsm6 libxext6 libxrender-dev

    - name: Install Apache Ant
      run: |
        wget https://archive.apache.org/dist/ant/binaries/apache-ant-1.9.4-bin.tar.gz
        tar -xzf apache-ant-1.9.4-bin.tar.gz
        echo "ANT_HOME=$PWD/apache-ant-1.9.4" >> $GITHUB_ENV
        echo "$PWD/apache-ant-1.9.4/bin" >> $GITHUB_PATH

    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install --no-cache-dir buildozer cython
        buildozer init || true

    - name: Set up Android SDK manually
      run: |
        mkdir -p ~/.buildozer/android/platform
        cd ~/.buildozer/android/platform
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip
        mkdir -p android-sdk/cmdline-tools
        mv cmdline-tools android-sdk/cmdline-tools/latest
        yes | android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=android-sdk --licenses
        android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=android-sdk \
          "platform-tools" \
          "platforms;android-31" \
          "build-tools;31.0.0"
        echo "sdk.dir=$HOME/.buildozer/android/platform/android-sdk" > ~/.buildozer/android/platform/android-sdk/local.properties

    - name: Build APK
      run: |
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kivy-app-apk
        path: bin/*.apk
